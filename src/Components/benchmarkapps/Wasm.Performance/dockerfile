FROM mcr.microsoft.com/dotnet/core/sdk:3.1 AS build

ARG DEBIAN_FRONTEND=noninteractive

# Setup for nodejs
RUN curl -sL https://deb.nodesource.com/setup_13.x | bash -

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    libunwind-dev \
    nodejs \
    git

# Change this before we merge
ARG commit=prkrishn/blazor-benchmarking

WORKDIR /src
RUN git init \
    && git fetch https://github.com/aspnet/aspnetcore $commit \
    && git reset --hard FETCH_HEAD \
    && git submodule update --init

RUN ls -a

RUN dotnet publish -c Release -r linux-x64 -o /app ./src/Components/benchmarkapps/Wasm.Performance/Driver/Wasm.Performance.Driver.csproj
RUN chmod +x /app/Wasm.Performance.Driver

FROM selenium/standalone-chrome:3.141.59-mercury as final
COPY --from=build ./app ./

# Supervisor configuration file
COPY /Driver/wasm.performance.conf /etc/supervisor/conf.d/